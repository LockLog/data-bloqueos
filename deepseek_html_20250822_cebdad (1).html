<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Datos - Google Sheets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: #333;
            padding-top: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
            cursor: pointer;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e9f7fe;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 12px;
            color: #6c757d;
        }
        
        .search-box input {
            padding-left: 40px;
            border-radius: 50px;
        }
        
        .pagination {
            margin-top: 1.5rem;
        }
        
        .footer {
            background-color: var(--secondary-color);
            color: white;
            padding: 1.5rem 0;
            margin-top: 2rem;
            border-radius: 10px;
        }
        
        .error-details {
            font-size: 0.9rem;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="fas fa-table me-2"></i>Visualizador de Datos</h1>
            <p class="lead">Datos obtenidos desde Google Sheets - Columnas D a L</p>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>Información</h5>
                        <p class="card-text">
                            Esta página muestra los datos de las columnas D, E, F, G, H, J, K, L de la hoja "Base" 
                            del documento de Google Sheets enlazado.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-filter me-2"></i>Filtrar Datos</h5>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-input" class="form-control" placeholder="Buscar en los datos...">
                        </div>
                        <div class="form-text">
                            Escribe para filtrar los resultados. Presiona Enter para buscar.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-table me-2"></i>Datos de la Hoja "Base"</h5>
                
                <div id="loading" class="loading">
                    <div class="spinner-border text-primary spinner" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
                
                <div id="error-message" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="error-text">Ha ocurrido un error al cargar los datos.</span>
                    <button id="show-details" class="btn btn-sm btn-outline-danger ms-2">Detalles</button>
                    <div id="error-details" class="error-details mt-2"></div>
                </div>
                
                <div id="table-container" class="table-container d-none">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th data-column="0">Columna D <i class="fas fa-sort"></i></th>
                                <th data-column="1">Columna E <i class="fas fa-sort"></i></th>
                                <th data-column="2">Columna F <i class="fas fa-sort"></i></th>
                                <th data-column="3">Columna G <i class="fas fa-sort"></i></th>
                                <th data-column="4">Columna H <i class="fas fa-sort"></i></th>
                                <th data-column="5">Columna J <i class="fas fa-sort"></i></th>
                                <th data-column="6">Columna K <i class="fas fa-sort"></i></th>
                                <th data-column="7">Columna L <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="data-body">
                            <!-- Los datos se insertarán aquí mediante JavaScript -->
                        </tbody>
                    </table>
                    
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- La paginación se generará aquí -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <div class="footer text-center">
            <p>&copy; 2023 Visualizador de Datos desde Google Sheets</p>
            <p class="small">Los datos se cargan directamente desde Google Sheets</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variables globales
            let allData = [];
            let currentPage = 1;
            const rowsPerPage = 10;
            let sortColumn = null;
            let sortDirection = 'asc';
            let currentFilter = '';
            
            // Elementos DOM
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const errorDetails = document.getElementById('error-details');
            const showDetailsBtn = document.getElementById('show-details');
            const tableContainer = document.getElementById('table-container');
            const dataBody = document.getElementById('data-body');
            const paginationElement = document.getElementById('pagination');
            const searchInput = document.getElementById('search-input');
            
            // Función segura para manipulación de clases
            function safeClassManipulation(element, method, className) {
                if (!element || !className || typeof className !== 'string') return;
                
                // Limpiar y validar el nombre de la clase
                const cleanClassName = className.trim();
                if (!cleanClassName) return;
                
                try {
                    if (method === 'add') {
                        element.classList.add(cleanClassName);
                    } else if (method === 'remove') {
                        element.classList.remove(cleanClassName);
                    } else if (method === 'toggle') {
                        element.classList.toggle(cleanClassName);
                    }
                } catch (error) {
                    console.error('Error manipulando clases:', error);
                    showError('Error manipulando clases del elemento', error);
                }
            }
            
            // Convertir URL pública a URL para la API
            function getSheetApiUrl(publicUrl) {
                try {
                    // Extraer el ID de la hoja de cálculo de la URL
                    const match = publicUrl.match(/\/d\/e\/(.*?)\/pub/);
                    if (match && match[1]) {
                        const sheetId = match[1];
                        return `https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?output=csv`;
                    }
                    throw new Error('URL de Google Sheets no válida');
                } catch (error) {
                    showError('Error procesando URL', error);
                    return null;
                }
            }
            
            // Cargar datos desde Google Sheets
            async function loadData() {
                try {
                    safeClassManipulation(loadingElement, 'remove', 'd-none');
                    safeClassManipulation(errorElement, 'add', 'd-none');
                    safeClassManipulation(tableContainer, 'add', 'd-none');
                    
                    const publicUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSHCjQOeomFX3tsydj1QMJ6_H8jxx4y-Y18uDS0EdFTjvbDXDyrMqgKOqbvzchhWg/pubhtml';
                    const apiUrl = getSheetApiUrl(publicUrl);
                    
                    if (!apiUrl) {
                        throw new Error('No se pudo generar la URL de la API');
                    }
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    
                    const csvData = await response.text();
                    processData(csvData);
                    
                } catch (error) {
                    showError(`Error al cargar los datos: ${error.message}`, error);
                }
            }
            
            // Procesar datos CSV
            function processData(csvData) {
                try {
                    const rows = csvData.split('\n');
                    if (rows.length < 2) {
                        throw new Error('El archivo CSV no contiene datos');
                    }
                    
                    const headers = rows[0].split(',').map(header => header.trim());
                    
                    // Encontrar los índices de las columnas D, E, F, G, H, J, K, L
                    // Las columnas en CSV son 0-indexed: D=3, E=4, F=5, G=6, H=7, J=9, K=10, L=11
                    const targetColumns = [3, 4, 5, 6, 7, 9, 10, 11];
                    
                    allData = [];
                    
                    for (let i = 1; i < rows.length; i++) {
                        if (rows[i].trim() === '') continue;
                        
                        const cells = rows[i].split(',').map(cell => cell.trim());
                        const rowData = {};
                        
                        targetColumns.forEach((colIndex, idx) => {
                            // Validar que el índice de columna existe
                            if (colIndex >= cells.length) {
                                rowData[`col${idx}`] = '';
                                return;
                            }
                            
                            if (cells[colIndex] !== undefined) {
                                rowData[`col${idx}`] = cells[colIndex];
                            } else {
                                rowData[`col${idx}`] = '';
                            }
                        });
                        
                        allData.push(rowData);
                    }
                    
                    if (allData.length === 0) {
                        throw new Error('No se encontraron datos en las columnas especificadas');
                    }
                    
                    renderTable();
                    
                } catch (error) {
                    showError(`Error al procesar los datos: ${error.message}`, error);
                }
            }
            
            // Mostrar error
            function showError(message, error = null) {
                safeClassManipulation(loadingElement, 'add', 'd-none');
                safeClassManipulation(errorElement, 'remove', 'd-none');
                
                errorText.textContent = message;
                
                if (error) {
                    errorDetails.textContent = error.stack || error.toString();
                }
            }
            
            // Renderizar tabla con paginación
            function renderTable() {
                safeClassManipulation(loadingElement, 'add', 'd-none');
                safeClassManipulation(tableContainer, 'remove', 'd-none');
                
                // Aplicar filtro si existe
                let filteredData = allData;
                if (currentFilter) {
                    const filterLower = currentFilter.toLowerCase();
                    filteredData = allData.filter(row => {
                        return Object.values(row).some(value => 
                            value && value.toLowerCase().includes(filterLower)
                        );
                    });
                }
                
                // Aplicar ordenamiento si existe
                if (sortColumn !== null) {
                    filteredData.sort((a, b) => {
                        const aValue = a[`col${sortColumn}`] || '';
                        const bValue = b[`col${sortColumn}`] || '';
                        
                        if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                        if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                
                // Calcular paginación
                const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                if (currentPage > totalPages) currentPage = 1;
                
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
                const pageData = filteredData.slice(startIndex, endIndex);
                
                // Renderizar filas de la tabla
                dataBody.innerHTML = '';
                
                if (pageData.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="8" class="text-center">No se encontraron datos</td>`;
                    dataBody.appendChild(noDataRow);
                } else {
                    pageData.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.col0 || ''}</td>
                            <td>${row.col1 || ''}</td>
                            <td>${row.col2 || ''}</td>
                            <td>${row.col3 || ''}</td>
                            <td>${row.col4 || ''}</td>
                            <td>${row.col5 || ''}</td>
                            <td>${row.col6 || ''}</td>
                            <td>${row.col7 || ''}</td>
                        `;
                        dataBody.appendChild(tr);
                    });
                }
                
                // Renderizar paginación
                renderPagination(filteredData.length, totalPages);
            }
            
            // Renderizar controles de paginación
            function renderPagination(totalItems, totalPages) {
                paginationElement.innerHTML = '';
                
                if (totalPages <= 1) return;
                
                // Botón Anterior
                const prevLi = document.createElement('li');
                safeClassManipulation(prevLi, 'add', 'page-item');
                if (currentPage === 1) {
                    safeClassManipulation(prevLi, 'add', 'disabled');
                }
                prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a>`;
                paginationElement.appendChild(prevLi);
                
                // Páginas
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageLi = document.createElement('li');
                    const classes = i === currentPage ? 'page-item active' : 'page-item';
                    safeClassManipulation(pageLi, 'add', classes);
                    pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    paginationElement.appendChild(pageLi);
                }
                
                // Botón Siguiente
                const nextLi = document.createElement('li');
                safeClassManipulation(nextLi, 'add', 'page-item');
                if (currentPage === totalPages) {
                    safeClassManipulation(nextLi, 'add', 'disabled');
                }
                nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Siguiente</a>`;
                paginationElement.appendChild(nextLi);
            }
            
            // Ordenar tabla por columna
            function sortTable(columnIndex) {
                if (sortColumn === columnIndex) {
                    // Cambiar dirección si es la misma columna
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // Nueva columna, orden ascendente por defecto
                    sortColumn = columnIndex;
                    sortDirection = 'asc';
                }
                
                renderTable();
            }
            
            // Event Listeners
            document.querySelectorAll('th').forEach(th => {
                th.addEventListener('click', () => {
                    const columnIndex = parseInt(th.getAttribute('data-column'));
                    if (!isNaN(columnIndex)) {
                        sortTable(columnIndex);
                    }
                });
            });
            
            paginationElement.addEventListener('click', (e) => {
                if (e.target.tagName === 'A') {
                    e.preventDefault();
                    const page = parseInt(e.target.getAttribute('data-page'));
                    if (!isNaN(page)) {
                        currentPage = page;
                        renderTable();
                    }
                }
            });
            
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    currentFilter = searchInput.value.trim();
                    currentPage = 1;
                    renderTable();
                }
            });
            
            showDetailsBtn.addEventListener('click', () => {
                const details = document.getElementById('error-details');
                if (details.style.display === 'none' || !details.style.display) {
                    details.style.display = 'block';
                    showDetailsBtn.textContent = 'Ocultar';
                } else {
                    details.style.display = 'none';
                    showDetailsBtn.textContent = 'Detalles';
                }
            });
            
            // Inicializar carga de datos
            loadData();
        });
    </script>
</body>
</html>